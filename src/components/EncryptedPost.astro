---
import { SiteConfig } from '../config';
import CryptoJS from 'crypto-js';
import { renderMarkdownToHtml } from '../utils/markdown';

interface Props {
  content: string; // Markdown source
}

const { content } = Astro.props;
const isEnabled = !!SiteConfig.password;

let encrypted = '';
let html = '';

if (isEnabled) {
    // Server-side encryption
    encrypted = CryptoJS.AES.encrypt(content, SiteConfig.password).toString();
} else {
    // Render Markdown directly
    html = renderMarkdownToHtml(content);
}
---

{ !isEnabled ? (
    <div class="prose prose-invert prose-green max-w-none" set:html={html} />
) : (
    <>
        <div id="encrypted-container" class="hidden">
            <div id="encrypted-data" data-content={encrypted} class="hidden"></div>
            <div id="decrypted-content" class="prose prose-invert prose-green max-w-none">
                <!-- Content will be injected here -->
                <div class="animate-pulse text-zinc-500">Decrypting content stream...</div>
            </div>
        </div>

        <div id="encryption-lock" class="border border-red-900/50 bg-red-950/10 p-4 rounded text-center text-red-400 font-mono text-sm my-8">
            <div class="mb-2 text-2xl">ðŸ”’</div>
            <div class="font-bold">ENCRYPTED DATA BLOB</div>
            <div class="text-xs opacity-70 mt-1">Awaiting authentication key...</div>
            <div class="text-[10px] text-zinc-600 mt-4 break-all font-mono opacity-50">
                {encrypted.substring(0, 64)}...
            </div>
        </div>

        <script>
            import CryptoJS from 'crypto-js';
            import hljs from 'highlight.js/lib/core';
            import bash from 'highlight.js/lib/languages/bash';
            import c from 'highlight.js/lib/languages/c';
            import cpp from 'highlight.js/lib/languages/cpp';
            import css from 'highlight.js/lib/languages/css';
            import go from 'highlight.js/lib/languages/go';
            import java from 'highlight.js/lib/languages/java';
            import javascript from 'highlight.js/lib/languages/javascript';
            import json from 'highlight.js/lib/languages/json';
            import markdown from 'highlight.js/lib/languages/markdown';
            import python from 'highlight.js/lib/languages/python';
            import rust from 'highlight.js/lib/languages/rust';
            import typescript from 'highlight.js/lib/languages/typescript';
            import xml from 'highlight.js/lib/languages/xml';
            import yaml from 'highlight.js/lib/languages/yaml';
            import { marked } from 'marked';

            hljs.registerLanguage('bash', bash);
            hljs.registerLanguage('c', c);
            hljs.registerLanguage('cpp', cpp);
            hljs.registerLanguage('css', css);
            hljs.registerLanguage('go', go);
            hljs.registerLanguage('java', java);
            hljs.registerLanguage('javascript', javascript);
            hljs.registerLanguage('js', javascript);
            hljs.registerLanguage('json', json);
            hljs.registerLanguage('markdown', markdown);
            hljs.registerLanguage('md', markdown);
            hljs.registerLanguage('python', python);
            hljs.registerLanguage('py', python);
            hljs.registerLanguage('rust', rust);
            hljs.registerLanguage('rs', rust);
            hljs.registerLanguage('typescript', typescript);
            hljs.registerLanguage('ts', typescript);
            hljs.registerLanguage('xml', xml);
            hljs.registerLanguage('html', xml);
            hljs.registerLanguage('yaml', yaml);
            hljs.registerLanguage('yml', yaml);

            const renderer = new marked.Renderer();
            renderer.code = ({ text, lang }: any) => {
              const language = (lang || '').trim().split(/\s+/)[0];
              const hasLanguage = !!language && !!hljs.getLanguage(language);
              const result = hasLanguage
                ? hljs.highlight(text, { language, ignoreIllegals: true }).value
                : hljs.highlightAuto(text).value;
              const languageClass = language ? ` language-${language}` : '';
              return `<pre><code class="hljs${languageClass}">${result}</code></pre>`;
            };

            const renderContent = (password: string) => {
                const dataEl = document.getElementById('encrypted-data');
                const container = document.getElementById('encrypted-container');
                const lock = document.getElementById('encryption-lock');
                const target = document.getElementById('decrypted-content');

                if (!dataEl || !target || !container || !lock) return;

                const encrypted = dataEl.dataset.content;
                
                const bytes = CryptoJS.AES.decrypt(encrypted, password);
                const decryptedMarkdown = bytes.toString(CryptoJS.enc.Utf8);
                
                if (!decryptedMarkdown) {
                    lock.innerHTML += `<div class="text-red-500 mt-2">Decryption Error: Invalid Key</div>`;
                    window.dispatchEvent(new CustomEvent('auth:failed'));
                    return;
                }

                try {
                    const html = marked.parse(decryptedMarkdown, { renderer, breaks: true, gfm: true }) as string;
                    target.innerHTML = html;
                } catch (e) {
                    console.error('Render failed', e);
                    const fallbackHtml = marked.parse(decryptedMarkdown, { breaks: true, gfm: true }) as string;
                    target.innerHTML = fallbackHtml;
                }
                
                container.classList.remove('hidden');
                lock.classList.add('hidden');
            };

            // Check if we already have the key
            const savedKey = sessionStorage.getItem('terminal_blog_key');
            if (savedKey) {
                renderContent(savedKey);
            }

            // Listen for new login
            window.addEventListener('auth:success', (e: any) => {
                const pwd = e.detail.password;
                renderContent(pwd);
            });
        </script>
    </>
)}
