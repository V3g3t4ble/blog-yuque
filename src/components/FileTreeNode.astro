---
import type { TreeNode } from '../utils/fileTree';

interface Props {
  node: TreeNode;
  currentSlug?: string;
  depth?: number;
}

const { node, currentSlug, depth = 0 } = Astro.props;
const isActive = node.slug === currentSlug;
const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : import.meta.env.BASE_URL + '/';
const href = `${base}posts/${node.slug}`.replace(/\/+/g, '/');
---

<div class="font-mono text-sm leading-6 select-none">
  {node.type === 'directory' || node.children.length > 0 ? (
    <details open>
      <summary 
        class="text-blue-400 font-bold hover:bg-zinc-800 cursor-pointer list-none flex items-center" 
        style={`padding-left: ${depth * 1.25}rem`}
      >
        <span class="arrow mr-2 transform transition-transform text-zinc-500 text-[10px] inline-block">‚ñ∂</span>
        <span class="folder-icon mr-1">üìÅ</span>
        
        {/* If node has a slug, it's a linkable directory/file */}
        {node.slug ? (
            <a href={`${base}posts/${node.slug}`.replace(/\/+/g, '/')} class="hover:text-blue-300 transition-colors">
                {node.name}
            </a>
        ) : (
            <span>{node.name}</span>
        )}
      </summary>
      {node.children.map((child) => (
        <Astro.self node={child} currentSlug={currentSlug} depth={depth + 1} />
      ))}
    </details>
  ) : (
    <a
      href={href}
      class:list={[
        "block hover:bg-zinc-800 transition-colors duration-200",
        isActive ? "text-green-400 font-bold bg-zinc-800" : "text-gray-400"
      ]}
      style={`padding-left: ${depth * 1.25}rem`}
    >
      <span class="mr-2">{isActive ? '>' : ' '}</span>
      üìÑ {node.name}
    </a>
  )}
</div>

<style>
  details[open] > summary > .arrow {
    transform: rotate(90deg);
  }
  
  /* Optional: Change folder icon when open 
     Using CSS content to swap emoji might be tricky with accessibility, 
     but we can toggle classes if we had two spans. 
     Let's use a simpler approach for now or just stick to the arrow rotation which is the main issue.
     Actually, let's try to swap the icon content using ::after or just JS? 
     CSS content replacement for text is possible.
  */
</style>

<script>
  // Simple script to toggle folder icon
  // This runs on client side to enhance the UI
  document.querySelectorAll('details').forEach((details) => {
    const icon = details.querySelector('.folder-icon');
    if (icon) {
        // Set initial state
        icon.textContent = details.open ? 'üìÇ' : 'üìÅ';
        
        // Listen for toggle
        details.addEventListener('toggle', () => {
            icon.textContent = details.open ? 'üìÇ' : 'üìÅ';
        });
    }
  });
</script>
