---
import { SiteConfig } from '../../config';
import CryptoJS from 'crypto-js';

interface Props {
  password?: string;
}

const { password = SiteConfig.password } = Astro.props;
const isEnabled = !!password;
const passwordHash = isEnabled ? CryptoJS.SHA512(password).toString() : '';
---

{!isEnabled ? (
  <slot />
) : (
  <>
    <div id="typora-auth-config" data-hash={passwordHash} class="hidden"></div>

    <div id="typora-login" class="typora-login hidden" aria-hidden="true">
      <div class="typora-login-backdrop" aria-hidden="true"></div>
      <div class="typora-login-card" role="dialog" aria-modal="true" aria-label="输入文章密码">
        <div class="typora-login-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
        </div>
        <div class="typora-login-subtitle">此文章受密码保护，请输入密码访问</div>

        <div class="typora-login-form">
          <input id="typora-password" class="typora-login-input" type="password" placeholder="文章密码" autocomplete="off" />
          <button id="typora-login-btn" class="typora-login-btn" type="button" aria-label="解锁">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x="1" y1="12" x2="19" y2="12"></line>
              <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
          </button>
        </div>
        <div id="typora-login-error" class="typora-login-error hidden"></div>
      </div>
    </div>

    <div id="typora-app" class="hidden">
      <slot />
    </div>

    <script>
      import CryptoJS from 'crypto-js';

      const SESSION_KEY = 'typora_blog_auth';
      const KEY_KEY = 'terminal_blog_key';

      const decryptAll = (inputPassword: string) => {
        const els = Array.from(document.querySelectorAll('[data-typora-aes]'));
        els.forEach((el) => {
          if (!(el instanceof HTMLElement)) return;
          const cipher = el.dataset.typoraAes;
          if (!cipher) return;
          const plain = CryptoJS.AES.decrypt(cipher, inputPassword).toString(CryptoJS.enc.Utf8);
          if (!plain) return;
          el.removeAttribute('data-typora-aes');
          el.innerHTML = plain;
        });
        document.dispatchEvent(new Event('astro:page-load'));
      };

      const showLogin = () => {
        const login = document.getElementById('typora-login');
        const app = document.getElementById('typora-app');
        if (!login || !app) return;
        document.documentElement.style.overflow = 'hidden';
        login.setAttribute('aria-hidden', 'false');
        login.classList.remove('hidden');
        app.classList.add('hidden');
        setTimeout(() => {
          const input = document.getElementById('typora-password');
          if (input instanceof HTMLInputElement) input.focus();
        }, 50);
      };

      const showApp = () => {
        const login = document.getElementById('typora-login');
        const app = document.getElementById('typora-app');
        if (!login || !app) return;
        document.documentElement.style.overflow = '';
        login.setAttribute('aria-hidden', 'true');
        login.classList.add('hidden');
        app.classList.remove('hidden');
      };

      const validate = (inputPassword: string) => {
        const cfg = document.getElementById('typora-auth-config');
        const targetHash = cfg?.dataset.hash;
        if (!targetHash) return false;
        const inputHash = CryptoJS.SHA512(inputPassword).toString();
        return inputHash === targetHash;
      };

      const setError = (msg: string) => {
        const el = document.getElementById('typora-login-error');
        if (!el) return;
        el.textContent = msg;
        el.classList.remove('hidden');
      };

      const clearError = () => {
        const el = document.getElementById('typora-login-error');
        if (!el) return;
        el.textContent = '';
        el.classList.add('hidden');
      };

      const attempt = () => {
        const input = document.getElementById('typora-password');
        if (!(input instanceof HTMLInputElement)) return;
        clearError();
        if (validate(input.value)) {
          sessionStorage.setItem(SESSION_KEY, 'true');
          sessionStorage.setItem(KEY_KEY, input.value);
          decryptAll(input.value);
          showApp();
        } else {
          setError('密码错误');
        }
      };

      const init = () => {
        const url = new URL(window.location.href);
        const forceLogin = url.searchParams.get('login') === '1';
        if (forceLogin) sessionStorage.removeItem(SESSION_KEY);
        const isAuth = sessionStorage.getItem(SESSION_KEY) === 'true';
        const storedPwd = sessionStorage.getItem(KEY_KEY) || '';
        if (isAuth && storedPwd && !forceLogin) {
          decryptAll(storedPwd);
          showApp();
        }
        else showLogin();

        const input = document.getElementById('typora-password');
        const btn = document.getElementById('typora-login-btn');

        if (input instanceof HTMLInputElement) {
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') attempt();
          });
          input.addEventListener('input', () => clearError());
        }
        btn?.addEventListener('click', () => attempt());
      };

      window.addEventListener('auth:open', () => {
        sessionStorage.removeItem(SESSION_KEY);
        sessionStorage.removeItem(KEY_KEY);
        clearError();
        const input = document.getElementById('typora-password');
        if (input instanceof HTMLInputElement) input.value = '';
        showLogin();
      });

      init();
    </script>

    <style>
      .typora-login.hidden,
      .typora-login-error.hidden,
      #typora-app.hidden {
        display: none;
      }

      .typora-login {
        position: fixed;
        inset: 0;
        width: 100%;
        min-height: 100vh;
        display: grid;
        place-items: center;
        font-family: 'Inter', system-ui, sans-serif;
        text-align: center;
        padding: 28px 20px;
        z-index: 90;
      }
      .typora-login-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(17, 24, 39, 0.22);
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
      }
      .typora-login-card {
        position: relative;
        width: min(520px, 100%);
        padding: 26px 22px 20px;
        border-radius: 18px;
        border: 1px solid var(--lp-border, rgba(0, 0, 0, 0.10));
        background: linear-gradient(180deg, var(--lp-glass-strong, rgba(255, 255, 255, 0.78)), var(--lp-glass, rgba(255, 255, 255, 0.62)));
        box-shadow: var(--lp-shadow, 0 18px 64px rgba(0, 0, 0, 0.12));
        -webkit-backdrop-filter: saturate(var(--lp-saturate, 180%)) blur(var(--lp-blur, 22px));
        backdrop-filter: saturate(var(--lp-saturate, 180%)) blur(var(--lp-blur, 22px));
      }
      .typora-login-icon {
        color: var(--lp-muted, #9ca3af);
        margin-bottom: 24px;
        padding: 20px;
        background: var(--lp-hover, rgba(0, 0, 0, 0.03));
        border-radius: 50%;
        display: inline-flex;
      }
      .typora-login-title {
        font-size: 20px;
        font-weight: 700;
        color: #111827;
        margin-bottom: 8px;
        letter-spacing: -0.02em;
      }
      .typora-login-subtitle {
        font-size: 15px;
        color: var(--lp-muted, #6b7280);
        margin-bottom: 32px;
      }
      .typora-login-form {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        max-width: 320px;
        position: relative;
      }
      .typora-login-input {
        flex: 1;
        height: 44px;
        border-radius: 12px;
        border: 1px solid var(--lp-border, rgba(0, 0, 0, 0.10));
        padding: 0 16px;
        font-size: 15px;
        outline: none;
        color: var(--lp-fg, #111827);
        background: var(--lp-glass-opaque, rgba(255, 255, 255, 0.78));
        transition: all 0.2s;
        -webkit-backdrop-filter: saturate(var(--lp-saturate, 180%)) blur(calc(var(--lp-blur, 22px) - 10px));
        backdrop-filter: saturate(var(--lp-saturate, 180%)) blur(calc(var(--lp-blur, 22px) - 10px));
      }
      .typora-login-input:focus {
        border-color: rgba(10, 132, 255, 0.65);
        background: rgba(255, 255, 255, 0.92);
        box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.16);
      }
      .typora-login-btn {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        border: 1px solid rgba(10, 132, 255, 0.24);
        background: linear-gradient(180deg, rgba(10, 132, 255, 0.98), rgba(10, 132, 255, 0.78));
        color: rgba(255, 255, 255, 0.96);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 180ms ease, box-shadow 180ms ease, background 180ms ease, border-color 180ms ease;
        box-shadow:
          0 16px 44px rgba(10, 132, 255, 0.28),
          0 10px 22px rgba(0, 0, 0, 0.10),
          inset 0 1px 0 rgba(255, 255, 255, 0.32);
      }
      .typora-login-btn:hover {
        border-color: rgba(10, 132, 255, 0.34);
        background: linear-gradient(180deg, rgba(10, 132, 255, 1), rgba(10, 132, 255, 0.82));
        transform: translateY(-1px) scale(1.01);
        box-shadow:
          0 18px 54px rgba(10, 132, 255, 0.34),
          0 12px 26px rgba(0, 0, 0, 0.12),
          inset 0 1px 0 rgba(255, 255, 255, 0.36);
      }
      .typora-login-btn:focus-visible {
        outline: 3px solid rgba(10, 132, 255, 0.22);
        outline-offset: 2px;
      }
      .typora-login-btn:active {
        transform: translateY(0) scale(0.99);
        box-shadow:
          0 12px 36px rgba(10, 132, 255, 0.26),
          0 8px 18px rgba(0, 0, 0, 0.10),
          inset 0 1px 0 rgba(255, 255, 255, 0.28);
      }
      .typora-login-error {
        margin-top: 12px;
        font-size: 13px;
        color: #dc2626;
        font-weight: 500;
        height: 20px;
      }
      @media (prefers-color-scheme: dark) {
        .typora-login-input {
           background: var(--lp-glass-opaque, rgba(28, 28, 30, 0.78));
           border-color: var(--lp-border, rgba(255, 255, 255, 0.14));
           color: var(--lp-fg, #f3f4f6);
        }
        .typora-login-input:focus {
           background: rgba(28, 28, 30, 0.92);
        }
        .typora-login-backdrop {
          background: rgba(0, 0, 0, 0.40);
        }
        .typora-login-btn {
          border-color: rgba(10, 132, 255, 0.26);
          background: linear-gradient(180deg, rgba(10, 132, 255, 0.96), rgba(10, 132, 255, 0.72));
          color: rgba(255, 255, 255, 0.96);
          box-shadow:
            0 18px 60px rgba(10, 132, 255, 0.24),
            0 14px 42px rgba(0, 0, 0, 0.46),
            inset 0 1px 0 rgba(255, 255, 255, 0.22);
        }
        .typora-login-btn:hover {
          border-color: rgba(10, 132, 255, 0.34);
          background: linear-gradient(180deg, rgba(10, 132, 255, 1), rgba(10, 132, 255, 0.78));
        }
      }
    </style>
  </>
)}
