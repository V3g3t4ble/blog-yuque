---
import { SiteConfig } from '../../config';
import CryptoJS from 'crypto-js';

interface Props {
  password?: string;
}

const { password = SiteConfig.password } = Astro.props;
const isEnabled = !!password;
const passwordHash = isEnabled ? CryptoJS.SHA512(password).toString() : '';
const wechatEnabled = SiteConfig.typora?.wechat?.enabled;
const wechatName = SiteConfig.typora?.wechat?.name;
const wechatQrImage = SiteConfig.typora?.wechat?.qrImage;
---

{!isEnabled ? (
  <slot />
) : (
  <>
    <div id="typora-auth-config" data-hash={passwordHash} class="hidden"></div>

    <div id="typora-login" class="typora-login hidden" aria-hidden="true">
      <div class="typora-login-card">
        <div class="typora-login-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
        </div>
        <div class="typora-login-subtitle">此文章受密码保护，请输入密码访问</div>

        <div class="typora-login-form">
          <input id="typora-password" class="typora-login-input" type="password" placeholder="文章密码" autocomplete="off" />
          <button id="typora-login-btn" class="typora-login-btn" type="button" aria-label="解锁">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x="1" y1="12" x2="19" y2="12"></line>
              <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
          </button>
        </div>
        <div id="typora-login-error" class="typora-login-error hidden"></div>

        {wechatEnabled ? (
          <div class="typora-login-help">
            <div class="typora-login-help-text">
              {wechatName ? <>关注公众号 <span class="typora-login-help-strong">{wechatName}</span> 获取密码</> : '联系作者获取访问密码'}
            </div>
            {wechatQrImage ? (
              <div class="typora-login-qr-wrapper">
                 <img class="typora-login-help-qr" src={wechatQrImage} alt="公众号二维码" loading="lazy" />
              </div>
            ) : null}
          </div>
        ) : null}
      </div>
    </div>

    <div id="typora-app" class="hidden">
      <slot />
    </div>

    <script>
      import CryptoJS from 'crypto-js';

      const SESSION_KEY = 'typora_blog_auth';
      const KEY_KEY = 'terminal_blog_key';

      const decryptAll = (inputPassword: string) => {
        const els = Array.from(document.querySelectorAll('[data-typora-aes]'));
        els.forEach((el) => {
          if (!(el instanceof HTMLElement)) return;
          const cipher = el.dataset.typoraAes;
          if (!cipher) return;
          const plain = CryptoJS.AES.decrypt(cipher, inputPassword).toString(CryptoJS.enc.Utf8);
          if (!plain) return;
          el.removeAttribute('data-typora-aes');
          el.innerHTML = plain;
        });
        document.dispatchEvent(new Event('astro:page-load'));
      };

      const showLogin = () => {
        const login = document.getElementById('typora-login');
        const app = document.getElementById('typora-app');
        if (!login || !app) return;
        login.setAttribute('aria-hidden', 'false');
        login.classList.remove('hidden');
        app.classList.add('hidden');
        setTimeout(() => {
          const input = document.getElementById('typora-password');
          if (input instanceof HTMLInputElement) input.focus();
        }, 50);
      };

      const showApp = () => {
        const login = document.getElementById('typora-login');
        const app = document.getElementById('typora-app');
        if (!login || !app) return;
        login.setAttribute('aria-hidden', 'true');
        login.classList.add('hidden');
        app.classList.remove('hidden');
      };

      const validate = (inputPassword: string) => {
        const cfg = document.getElementById('typora-auth-config');
        const targetHash = cfg?.dataset.hash;
        if (!targetHash) return false;
        const inputHash = CryptoJS.SHA512(inputPassword).toString();
        return inputHash === targetHash;
      };

      const setError = (msg: string) => {
        const el = document.getElementById('typora-login-error');
        if (!el) return;
        el.textContent = msg;
        el.classList.remove('hidden');
      };

      const clearError = () => {
        const el = document.getElementById('typora-login-error');
        if (!el) return;
        el.textContent = '';
        el.classList.add('hidden');
      };

      const attempt = () => {
        const input = document.getElementById('typora-password');
        if (!(input instanceof HTMLInputElement)) return;
        clearError();
        if (validate(input.value)) {
          sessionStorage.setItem(SESSION_KEY, 'true');
          sessionStorage.setItem(KEY_KEY, input.value);
          decryptAll(input.value);
          showApp();
        } else {
          setError('密码错误');
        }
      };

      const init = () => {
        const url = new URL(window.location.href);
        const forceLogin = url.searchParams.get('login') === '1';
        if (forceLogin) sessionStorage.removeItem(SESSION_KEY);
        const isAuth = sessionStorage.getItem(SESSION_KEY) === 'true';
        const storedPwd = sessionStorage.getItem(KEY_KEY) || '';
        if (isAuth && storedPwd && !forceLogin) {
          decryptAll(storedPwd);
          showApp();
        }
        else showLogin();

        const input = document.getElementById('typora-password');
        const btn = document.getElementById('typora-login-btn');

        if (input instanceof HTMLInputElement) {
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') attempt();
          });
          input.addEventListener('input', () => clearError());
        }
        btn?.addEventListener('click', () => attempt());
      };

      window.addEventListener('auth:open', () => {
        sessionStorage.removeItem(SESSION_KEY);
        sessionStorage.removeItem(KEY_KEY);
        clearError();
        const input = document.getElementById('typora-password');
        if (input instanceof HTMLInputElement) input.value = '';
        showLogin();
      });

      init();
    </script>

    <style>
      .typora-login.hidden,
      .typora-login-error.hidden,
      #typora-app.hidden {
        display: none;
      }

      .typora-login {
        position: relative;
        width: 100%;
        min-height: 400px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: 'Inter', system-ui, sans-serif;
        text-align: center;
        padding: 40px 20px;
      }
      .typora-login-icon {
        color: #9ca3af;
        margin-bottom: 24px;
        padding: 20px;
        background: rgba(0, 0, 0, 0.03);
        border-radius: 50%;
        display: inline-flex;
      }
      .typora-login-title {
        font-size: 20px;
        font-weight: 700;
        color: #111827;
        margin-bottom: 8px;
        letter-spacing: -0.02em;
      }
      .typora-login-subtitle {
        font-size: 15px;
        color: #6b7280;
        margin-bottom: 32px;
      }
      .typora-login-form {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        max-width: 320px;
        position: relative;
      }
      .typora-login-input {
        flex: 1;
        height: 44px;
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        padding: 0 16px;
        font-size: 15px;
        outline: none;
        color: #111827;
        background: rgba(255, 255, 255, 0.6);
        transition: all 0.2s;
      }
      .typora-login-input:focus {
        border-color: rgba(37, 99, 235, 0.5);
        background: #ffffff;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }
      .typora-login-btn {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        border: none;
        background: var(--lp-accent-1, #2563eb);
        color: #ffffff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
      }
      .typora-login-btn:hover {
        background: #1d4ed8;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
      }
      .typora-login-btn:active {
        transform: translateY(0);
      }
      .typora-login-error {
        margin-top: 12px;
        font-size: 13px;
        color: #dc2626;
        font-weight: 500;
        height: 20px; /* reserve space */
      }
      .typora-login-help {
        margin-top: 48px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }
      .typora-login-help-text {
        font-size: 13px;
        color: #6b7280;
      }
      .typora-login-help-strong {
        font-weight: 600;
        color: #374151;
      }
      .typora-login-qr-wrapper {
        padding: 8px;
        background: #fff;
        border-radius: 12px;
        border: 1px solid rgba(0,0,0,0.06);
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      }
      .typora-login-help-qr {
        width: 140px;
        height: 140px;
        border-radius: 6px;
        display: block;
      }
      @media (prefers-color-scheme: dark) {
        .typora-login-title { color: #f3f4f6; }
        .typora-login-subtitle { color: #9ca3af; }
        .typora-login-input {
           background: rgba(255, 255, 255, 0.05);
           border-color: rgba(255, 255, 255, 0.1);
           color: #f3f4f6;
        }
        .typora-login-input:focus {
           background: rgba(255, 255, 255, 0.1);
        }
        .typora-login-btn { background: #f3f4f6; color: #111827; }
        .typora-login-btn:hover { background: #ffffff; }
        .typora-login-icon { background: rgba(255, 255, 255, 0.05); color: #9ca3af; }
      }
    </style>
  </>
)}
