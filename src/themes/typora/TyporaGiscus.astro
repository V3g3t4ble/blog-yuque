---
import { SiteConfig } from '../../config';

const cfg = SiteConfig.giscus;
const enabled =
  !!cfg?.enabled &&
  !!cfg.repo &&
  !!cfg.repoId &&
  !!cfg.category &&
  !!cfg.categoryId &&
  !!cfg.mapping &&
  !!cfg.theme &&
  !!cfg.lang;
---

{enabled ? (
  <section class="typora-giscus" aria-label="评论">
    <div id="typora-giscus" class="giscus" />
    <div
      id="typora-giscus-config"
      class="hidden"
      data-repo={cfg.repo}
      data-repo-id={cfg.repoId}
      data-category={cfg.category}
      data-category-id={cfg.categoryId}
      data-mapping={cfg.mapping}
      data-strict={cfg.strict}
      data-reactions-enabled={cfg.reactionsEnabled}
      data-emit-metadata={cfg.emitMetadata}
      data-input-position={cfg.inputPosition}
      data-theme={cfg.theme}
      data-lang={cfg.lang}
    />
    <script>
      const cfg = document.getElementById('typora-giscus-config');
      const container = document.getElementById('typora-giscus');

      const mount = () => {
        if (!cfg || !container) return;
        if (document.querySelector('script[data-typora-giscus="1"]')) return;
        if (container.querySelector('iframe.giscus-frame')) return;

        const s = document.createElement('script');
        s.src = 'https://giscus.app/client.js';
        s.async = true;
        s.crossOrigin = 'anonymous';
        s.setAttribute('data-typora-giscus', '1');

        const ds = (cfg as HTMLElement).dataset as any;
        s.setAttribute('data-repo', ds.repo || '');
        s.setAttribute('data-repo-id', ds.repoId || '');
        s.setAttribute('data-category', ds.category || '');
        s.setAttribute('data-category-id', ds.categoryId || '');
        s.setAttribute('data-mapping', ds.mapping || 'pathname');
        s.setAttribute('data-strict', ds.strict || '0');
        s.setAttribute('data-reactions-enabled', ds.reactionsEnabled || '1');
        s.setAttribute('data-emit-metadata', ds.emitMetadata || '0');
        s.setAttribute('data-input-position', ds.inputPosition || 'top');
        s.setAttribute('data-theme', ds.theme || 'preferred_color_scheme');
        s.setAttribute('data-lang', ds.lang || 'zh-CN');

        container.appendChild(s);
      };

      const shouldMount = () => {
        const app = document.getElementById('typora-app');
        if (!app) return true;
        return !app.classList.contains('hidden');
      };

      const init = () => {
        if (shouldMount()) {
          mount();
          return;
        }
        const app = document.getElementById('typora-app');
        if (!app) return;
        const obs = new MutationObserver(() => {
          if (shouldMount()) {
            obs.disconnect();
            mount();
          }
        });
        obs.observe(app, { attributes: true, attributeFilter: ['class'] });
      };

      init();
      document.addEventListener('astro:page-load', init as any);
    </script>
  </section>
) : null}

<style>
  .typora-giscus {
    margin-top: 22px;
    padding-top: 22px;
    border-top: 1px solid var(--lp-border-soft, rgba(0, 0, 0, 0.08));
  }
</style>
