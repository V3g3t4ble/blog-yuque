<div class="typora-outline">
  <div class="typora-outline-header">大纲</div>
  <div id="typora-outline-empty" class="typora-outline-empty hidden">当前文章没有可用大纲</div>
  <ul id="typora-outline-list" class="typora-outline-list"></ul>
</div>

<script>
  const slugify = (text: string) => {
    return String(text)
      .trim()
      .toLowerCase()
      .replace(/<\/?[^>]+>/g, '')
      .replace(/[^\p{L}\p{N}\s-]/gu, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-')
      .replace(/^-|-$/g, '') || `h-${Math.random().toString(16).slice(2)}`;
  };

  const build = () => {
    const container = document.querySelector('article.typora-prose');
    const list = document.getElementById('typora-outline-list');
    const empty = document.getElementById('typora-outline-empty');
    if (!container || !list || !empty) return;

    list.innerHTML = '';

    const headings = Array.from(container.querySelectorAll('h1, h2, h3, h4'));
    if (headings.length === 0) {
      empty.classList.remove('hidden');
      return;
    }
    empty.classList.add('hidden');

    const used = new Set();
    headings.forEach((h) => {
      if (!(h instanceof HTMLElement)) return;
      let id = h.id;
      if (!id) {
        const base = slugify(h.textContent || '');
        id = base;
        let i = 2;
        while (used.has(id) || document.getElementById(id)) {
          id = `${base}-${i++}`;
        }
        h.id = id;
      }
      used.add(id);

      const level = Number(h.tagName.slice(1)) || 1;
      const li = document.createElement('li');
      li.style.setProperty('--level', String(Math.min(4, Math.max(1, level))));
      li.className = `typora-outline-item level-${level}`;
      li.innerHTML = `<a class="typora-outline-link" href="#${id}">${h.textContent || ''}</a>`;
      list.appendChild(li);
    });

    list.querySelectorAll('a').forEach((a) => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const href = a.getAttribute('href') || '';
        const id = href.startsWith('#') ? href.slice(1) : '';
        const target = id ? document.getElementById(id) : null;
        if (!target) return;
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        history.replaceState(null, '', `#${id}`);
      });
    });
  };

  build();
  document.addEventListener('astro:page-load', build as any);
</script>

<style is:global>
  .typora-outline {
    padding: 10px 10px 14px;
  }
  .typora-outline-header {
    padding: 6px 8px 10px;
    font-size: 11px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--lp-muted, #9ca3af);
    border-bottom: 1px solid var(--lp-border-soft, rgba(0, 0, 0, 0.06));
    margin-bottom: 8px;
    font-weight: 700;
  }
  .typora-outline-empty {
    padding: 10px 10px;
    color: var(--lp-muted, #6b7280);
    font-size: 13px;
  }
  .typora-outline-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 2px;
    position: relative;
  }
  .typora-outline-list::before {
    content: '';
    position: absolute;
    left: 14px;
    top: 0;
    bottom: 0;
    width: 1px;
    background: var(--lp-border-soft, rgba(0, 0, 0, 0.06));
  }
  .typora-outline-item {
    border-radius: 8px;
  }
  .typora-outline-link {
    display: block;
    padding: 6px 8px;
    border-radius: 8px;
    color: var(--lp-muted, #6b7280);
    text-decoration: none;
    font-size: 13px;
    line-height: 1.35;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    position: relative;
    padding-left: calc(26px + (var(--level, 1) - 1) * 18px) !important;
  }
  .typora-outline-link:hover {
    background: var(--lp-hover, rgba(0, 0, 0, 0.03));
    color: var(--lp-fg, #111827);
  }
  .typora-outline-link:focus-visible {
    outline: 2px solid rgba(10, 132, 255, 0.65);
    outline-offset: 2px;
    background: rgba(10, 132, 255, 0.12);
    color: var(--lp-fg, #111827);
  }
  .typora-outline-item.level-1 .typora-outline-link { font-weight: 600; color: var(--lp-fg, #4b5563); opacity: 0.92; }
  .typora-outline-item.level-2 .typora-outline-link { font-weight: 500; color: var(--lp-muted, #6b7280); }
  .typora-outline-item.level-3 .typora-outline-link { font-weight: 500; color: var(--lp-muted, #6b7280); opacity: 0.88; font-size: 12.5px; }
  .typora-outline-item.level-4 .typora-outline-link { font-weight: 500; color: var(--lp-muted, #6b7280); opacity: 0.82; font-size: 12px; }
  .typora-outline-link::before {
    content: '';
    position: absolute;
    left: calc(12px + (var(--level, 1) - 1) * 18px);
    top: 50%;
    width: 6px;
    height: 6px;
    margin-top: -3px;
    border-radius: 999px;
    background: var(--lp-border, rgba(0, 0, 0, 0.10));
  }
  .typora-outline-item.level-1 .typora-outline-link::before {
    width: 8px;
    height: 8px;
    margin-top: -4px;
    background: var(--lp-border, rgba(0, 0, 0, 0.16));
  }
  .typora-outline-item.level-2 .typora-outline-link::after,
  .typora-outline-item.level-3 .typora-outline-link::after,
  .typora-outline-item.level-4 .typora-outline-link::after {
    content: '';
    position: absolute;
    left: calc(16px + (var(--level, 1) - 1) * 18px);
    top: 50%;
    width: 12px;
    height: 1px;
    background: var(--lp-border, rgba(0, 0, 0, 0.10));
  }
  .typora-outline-item.level-2 .typora-outline-link::after,
  .typora-outline-item.level-3 .typora-outline-link::after,
  .typora-outline-item.level-4 .typora-outline-link::after {
    margin-top: 0;
  }
</style>
