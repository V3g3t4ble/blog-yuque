---
import { getCollection } from 'astro:content';
import { buildFileTree } from '../utils/fileTree';
import FileTree from '../components/FileTree.astro';
import Search from '../components/Search.astro';
import LoginGate from '../components/LoginGate.astro';
import { SiteConfig } from '../config';
import 'highlight.js/styles/github-dark.css';

interface Props {
  title: string;
  currentSlug?: string;
  meta?: {
    created?: string;
    updated?: string;
    words?: number;
    readMinutes?: number;
  };
}

const { title, currentSlug } = Astro.props;
const baseHref = import.meta.env.BASE_URL;
const homeHref = `${baseHref}home`;
const hasPassword = !!SiteConfig.password;

const posts = await getCollection('posts');
const tree = buildFileTree(posts);
---

<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title} | {SiteConfig.title}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style is:global>
      :root {
        font-family: 'JetBrains Mono', monospace;
      }
      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      ::-webkit-scrollbar-track {
        background: #18181b;
      }
      ::-webkit-scrollbar-thumb {
        background: #3f3f46;
        border-radius: 5px;
        border: 2px solid #18181b;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #52525b;
      }
      
      /* Typography Overrides for Terminal Theme */
      .prose blockquote {
        color: #a1a1aa; /* zinc-400 */
        border-left-color: #22c55e; /* green-500 */
        background: rgba(34, 197, 94, 0.05);
        font-style: normal;
        padding: 0.5rem 1rem;
        border-radius: 0 0.25rem 0.25rem 0;
      }
      .prose blockquote p:first-of-type::before,
      .prose blockquote p:last-of-type::after {
        content: none;
      }
      
      .prose table {
        border-collapse: collapse;
        border: 1px solid #27272a; /* zinc-800 */
        width: 100%;
        margin-top: 1.5em;
        margin-bottom: 1.5em;
      }
      .prose th {
        background: #18181b; /* zinc-900 */
        color: #22c55e; /* green-500 */
        border: 1px solid #27272a;
        padding: 0.75rem;
        text-align: left;
      }
      .prose td {
        border: 1px solid #27272a;
        padding: 0.75rem;
      }
      .prose hr {
        border-color: #27272a;
      }
      
      /* Force readable text colors in prose to override inline styles from content sources */
      /* 1. Force container colors (including div, but be careful with inheritance) */
      .prose :where(
        h1, h2, h3, h4, h5, h6,
        p, ul, ol, li,
        table, thead, tbody, tr, th, td,
        blockquote,
        dl, dt, dd,
        figcaption,
        div:not(.not-prose):not(.astro-code)
      ) {
        color: #e4e4e7 !important; /* zinc-200 */
      }

      /* 2. Force spans inside "Safe" containers to inherit color (overriding inline styles) */
      /* Exclude 'div' from this list to prevent breaking code block syntax highlighting (which uses spans) */
      .prose :where(
        h1, h2, h3, h4, h5, h6,
        p, ul, ol, li,
        table, thead, tbody, tr, th, td,
        dl, dt, dd,
        figcaption
      ) span {
        color: inherit !important;
      }
      
      /* 3. Aggressive reset for Blockquotes: Explicitly force color on common containers */
      .prose blockquote,
      .prose blockquote p,
      .prose blockquote span,
      .prose blockquote div {
        color: #a1a1aa !important;
      }
      
      /* Restore link/code/bold colors inside blockquotes */
      .prose blockquote a, .prose blockquote a span { color: #60a5fa !important; }
      .prose blockquote code, .prose blockquote code span { color: #f472b6 !important; }
      .prose blockquote strong, .prose blockquote b, .prose blockquote strong span, .prose blockquote b span { color: #fff !important; }
      
      /* Re-assert specific colors that should be different */
      .prose a, .prose a span { color: #60a5fa !important; } /* blue-400 */
      .prose strong, .prose b, .prose strong span, .prose b span { color: #fff !important; }
      .prose code { color: #f472b6 !important; } /* pink-400 */
      .prose th { color: #22c55e !important; } /* green-500 */
      
      /* Protect code blocks from global color overrides */
      .prose pre { color: inherit !important; }
      .prose pre code { color: inherit !important; }

      .terminal-codeblock {
        margin: 1.2em 0;
        border: 1px solid rgba(255, 255, 255, 0.10);
        border-radius: 10px;
        overflow: hidden;
        background: #0b0b0d;
      }
      .terminal-codeblock .terminal-codeblock-toolbar {
        height: 34px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 10px 0 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(24, 24, 27, 0.80);
      }
      .terminal-codeblock .terminal-codeblock-lang {
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.10em;
        text-transform: uppercase;
        color: #a1a1aa;
        user-select: none;
      }
      .terminal-codeblock .terminal-codeblock-copy {
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(63, 63, 70, 0.35);
        color: #e4e4e7;
        height: 26px;
        padding: 0 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
      }
      .terminal-codeblock .terminal-codeblock-copy:hover {
        border-color: rgba(34, 197, 94, 0.35);
        background: rgba(34, 197, 94, 0.12);
        color: #fff;
      }
      .terminal-codeblock pre {
        margin: 0 !important;
        background: transparent !important;
      }
      .terminal-codeblock pre > code {
        display: block;
        padding: 12px 16px 14px;
        background: transparent !important;
      }
    </style>
  </head>
  <body class="bg-zinc-950 text-gray-200 font-mono h-screen flex flex-col overflow-hidden selection:bg-green-900 selection:text-green-100">
    <LoginGate>
    <!-- Top Bar -->
    <header class="h-10 bg-zinc-900 border-b border-zinc-800 flex items-center px-4 justify-between text-xs shrink-0 z-10">
      <div class="flex items-center gap-2">
        <div class="flex gap-2 mr-4">
          <button id="close-sidebar" class="w-3 h-3 rounded-full bg-red-500 hover:bg-red-400 transition-colors focus:outline-none" aria-label="Close sidebar"></button>
          <button id="minimize-sidebar" class="w-3 h-3 rounded-full bg-yellow-500 hover:bg-yellow-400 transition-colors focus:outline-none" aria-label="Minimize sidebar"></button>
          <button id="expand-sidebar" class="w-3 h-3 rounded-full bg-green-500 hover:bg-green-400 transition-colors focus:outline-none" aria-label="Expand sidebar"></button>
        </div>
        <a href={homeHref} class="text-gray-400 flex items-center gap-2 hover:text-gray-300 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><rect x="9" y="9" width="6" height="6"></rect><line x1="9" y1="1" x2="9" y2="4"></line><line x1="15" y1="1" x2="15" y2="4"></line><line x1="9" y1="20" x2="9" y2="23"></line><line x1="15" y1="20" x2="15" y2="23"></line><line x1="20" y1="9" x2="23" y2="9"></line><line x1="20" y1="14" x2="23" y2="14"></line><line x1="1" y1="9" x2="4" y2="9"></line><line x1="1" y1="14" x2="4" y2="14"></line></svg>
          {SiteConfig.terminal.username}@{SiteConfig.terminal.hostname}: {SiteConfig.terminal.prompt.directory}
        </a>
      </div>
      <div class="text-gray-500 flex items-center gap-4">
        {hasPassword ? (
          <button id="terminal-logout" class="border border-zinc-700/70 bg-zinc-800/60 hover:bg-zinc-800 text-zinc-200 px-2 py-1 rounded text-[11px] transition-colors" type="button" aria-label="登出">
            logout
          </button>
        ) : null}
        <span class="hidden md:inline">Last login: {new Date().toLocaleDateString()}</span>
        <span class="bg-zinc-800 px-2 py-1 rounded">{SiteConfig.terminal.shell}</span>
      </div>
    </header>
    <div id="terminal-base" data-base={baseHref} class="hidden"></div>

    <div class="flex-1 flex overflow-hidden">
      <!-- Sidebar -->
      <aside class="w-72 bg-zinc-900/50 border-r border-zinc-800 overflow-hidden hidden md:flex flex-col shrink-0 backdrop-blur-sm">
        <Search posts={posts} />
        <div id="file-tree-container" class="flex-1 overflow-y-auto">
            <FileTree tree={tree} currentSlug={currentSlug} />
        </div>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 overflow-y-auto p-6 md:p-12 relative">
        <div class="max-w-3xl mx-auto min-h-full">
           <!-- Prompt line before content -->
           <div class="flex items-center gap-2 text-green-500 mb-8 font-bold text-lg border-b border-zinc-800 pb-4">
              <span>➜</span>
              <span class="text-blue-400">{SiteConfig.terminal.prompt.directory}</span>
              <span class="text-gray-400">git:(</span>
              <span class={SiteConfig.terminal.prompt.branchColor}>{SiteConfig.terminal.prompt.branch}</span>
              <span class="text-gray-400">)</span>
              <span class="text-yellow-400">cat {title !== 'Home' ? `${title}.md` : 'README.md'}</span>
              <span class="animate-pulse">_</span>
           </div>

           <article class="prose prose-invert prose-green max-w-none">
             <slot />
           </article>
           
           <div class="mt-12 pt-8 border-t border-zinc-800 text-zinc-500 text-sm">
              <p>-- End of Buffer --</p>
           </div>
        </div>
      </main>
    </div>
    
    <!-- Status Bar -->
    <footer class="h-6 bg-blue-600 text-black text-xs flex items-center px-4 justify-between font-bold shrink-0">
      <div class="flex gap-4">
        <span class="bg-blue-700 px-2 -ml-4 h-6 flex items-center">NORMAL</span>
        <span class="flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
          {currentSlug ? `${SiteConfig.terminal.prompt.directory}/${title}.md` : `${SiteConfig.terminal.prompt.directory}/README.md`}
        </span>
      </div>
      <div class="flex gap-4">
        <span>markdown</span>
        <span>100%</span>
        <span>Ln {currentSlug ? '42' : '1'}, Col 1</span>
        <span class="ml-4">UTF-8</span>
      </div>
    </footer>
    
    <script>
      const sidebar = document.querySelector('aside');
      const closeBtn = document.getElementById('close-sidebar');
      const minimizeBtn = document.getElementById('minimize-sidebar');
      const expandBtn = document.getElementById('expand-sidebar');
      const logoutBtn = document.getElementById('terminal-logout');
      logoutBtn?.addEventListener('click', () => {
        sessionStorage.removeItem('typora_blog_auth');
        sessionStorage.removeItem('terminal_blog_auth');
        sessionStorage.removeItem('terminal_blog_key');
        const base = (document.getElementById('terminal-base') as HTMLElement | null)?.dataset.base || '/';
        window.location.href = base;
      });

      // Helper to toggle sidebar
      const toggleSidebar = (show: boolean) => {
        if (!sidebar) return;
        if (show) {
          sidebar.classList.remove('hidden');
          sidebar.classList.add('flex');
        } else {
          sidebar.classList.add('hidden');
          sidebar.classList.remove('flex');
        }
      };

      // Red button: Hide sidebar
      closeBtn?.addEventListener('click', () => toggleSidebar(false));

      // Yellow button: Minimize (same as hide for now)
      minimizeBtn?.addEventListener('click', () => toggleSidebar(false));

      // Green button: Show sidebar
      expandBtn?.addEventListener('click', () => toggleSidebar(true));
      
      // Also allow reopening if user clicks the "expand" button again (though it might be hidden if sidebar is hidden)
      // A better UX might be to have a floating toggle or keep the top bar always visible with buttons.
      // Since the buttons are in the header, they are always visible!

      const getLanguageLabel = (codeEl: Element) => {
        const cls = codeEl.getAttribute('class') || '';
        const m = cls.match(/\blanguage-([a-zA-Z0-9_+-]+)\b/);
        return (m?.[1] || 'code').toLowerCase();
      };

      const copyText = async (text: string) => {
        if (navigator.clipboard?.writeText) {
          await navigator.clipboard.writeText(text);
          return;
        }
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.top = '0';
        ta.style.left = '0';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        document.execCommand('copy');
        ta.remove();
      };

      const enhanceCodeBlocks = () => {
        const codes = document.querySelectorAll('article.prose pre > code');
        codes.forEach((codeEl) => {
          const pre = codeEl.parentElement;
          if (!pre) return;
          if (pre.dataset.enhanced === 'true') return;
          pre.dataset.enhanced = 'true';

          const wrapper = document.createElement('div');
          wrapper.className = 'terminal-codeblock';

          const toolbar = document.createElement('div');
          toolbar.className = 'terminal-codeblock-toolbar';

          const lang = document.createElement('div');
          lang.className = 'terminal-codeblock-lang';
          lang.textContent = getLanguageLabel(codeEl);

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'terminal-codeblock-copy';
          btn.textContent = 'copy';

          btn.addEventListener('click', async () => {
            const text = codeEl.textContent || '';
            try {
              await copyText(text);
              btn.textContent = 'copied';
              setTimeout(() => (btn.textContent = 'copy'), 1200);
            } catch {
              btn.textContent = 'failed';
              setTimeout(() => (btn.textContent = 'copy'), 1200);
            }
          });

          toolbar.appendChild(lang);
          toolbar.appendChild(btn);

          pre.parentElement?.insertBefore(wrapper, pre);
          wrapper.appendChild(toolbar);
          wrapper.appendChild(pre);
        });
      };

      enhanceCodeBlocks();
      document.addEventListener('astro:page-load', enhanceCodeBlocks);
    </script>
    </LoginGate>
  </body>
</html>
